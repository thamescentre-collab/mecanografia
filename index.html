<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Thames Centre Typing Master</title>
<link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
<style>
:root {
--primary: #4f46e5;
--primary-light: #818cf8;
--secondary: #10b981;
--danger: #ef4444;
--dark: #1e293b;
--light: #f8fafc;
--gray: #94a3b8;
--gray-light: #e2e8f0;
--shadow: 0 10px 25px rgba(0, 0, 0, 0.1);
--transition: all 0.3s ease;
/* Colores para dedos */
--left-pinky-color: #f87171; /* Rojo claro */
--left-ring-color: #fb923c; /* Naranja */
--left-middle-color: #facc15; /* Amarillo */
--left-index-color: #4ade80; /* Verde */
--right-index-color: #60a5fa; /* Azul */
--right-middle-color: #c084fc; /* Morado */
--right-ring-color: #f472b6; /* Rosa */
--right-pinky-color: #94a3b8; /* Gris */
--thumb-color: #64748b; /* Gris oscuro */
}
* {
margin: 0;
padding: 0;
box-sizing: border-box;
font-family: 'Poppins', sans-serif;
}
body {
background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
min-height: 100vh;
display: flex;
flex-direction: column;
align-items: center;
padding: 20px;
color: var(--dark);
overflow-x: hidden; /* Prevenir scroll horizontal */
}
.app-container {
width: 100%;
max-width: 1200px;
background-color: white;
border-radius: 16px;
box-shadow: var(--shadow);
overflow: hidden;
margin-bottom: 30px;
}
.app-header {
background: linear-gradient(135deg, var(--primary) 0%, var(--primary-light) 100%);
color: white;
padding: 25px 40px;
text-align: center;
}
.app-header h1 {
font-size: 2.5rem;
font-weight: 700;
margin-bottom: 10px;
text-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
}
.app-header p {
font-size: 1.1rem;
opacity: 0.9;
}
.main-content {
padding: 30px;
}
/* Pantalla de login */
.login-container {
display: flex;
flex-direction: column;
align-items: center;
justify-content: center;
padding: 40px;
max-width: 500px;
margin: 0 auto;
}
.login-form {
background-color: white;
border-radius: 16px;
box-shadow: var(--shadow);
padding: 40px;
width: 100%;
}
.login-title {
font-size: 2rem;
font-weight: 700;
margin-bottom: 30px;
text-align: center;
color: var(--primary);
}
.login-subtitle {
font-size: 1rem;
font-weight: 500;
margin-bottom: 20px;
text-align: center;
color: var(--gray);
}
.form-group {
margin-bottom: 20px;
}
.form-group label {
display: block;
margin-bottom: 8px;
font-weight: 500;
color: var(--dark);
}
.form-group input, .form-group select, .form-group textarea {
width: 100%;
padding: 12px 15px;
border: 1px solid var(--gray-light);
border-radius: 8px;
font-size: 1rem;
transition: var(--transition);
}
.form-group input:focus, .form-group select:focus, .form-group textarea:focus {
outline: none;
border-color: var(--primary);
box-shadow: 0 0 0 3px rgba(79, 70, 229, 0.1);
}
.form-group textarea {
min-height: 120px;
resize: vertical;
}
.btn {
background-color: var(--primary);
color: white;
border: none;
border-radius: 8px;
padding: 12px 25px;
font-size: 1rem;
font-weight: 600;
cursor: pointer;
transition: var(--transition);
display: flex;
align-items: center;
justify-content: center;
gap: 8px;
}
.btn:hover {
background-color: #4338ca;
transform: translateY(-2px);
}
.btn-secondary {
background-color: var(--gray);
}
.btn-secondary:hover {
background-color: #64748b;
}
.btn-danger {
background-color: var(--danger);
}
.btn-danger:hover {
background-color: #dc2626;
}
.login-options {
display: flex;
justify-content: space-between;
margin-top: 30px;
}
.login-options button {
flex: 1;
margin: 0 5px;
}
.user-type {
display: flex;
justify-content: center;
margin-bottom: 20px;
gap: 20px;
}
.user-type button {
flex: 1;
padding: 10px;
border: 2px solid var(--gray-light);
background-color: white;
border-radius: 8px;
cursor: pointer;
transition: var(--transition);
}
.user-type button.active {
border-color: var(--primary);
background-color: rgba(79, 70, 229, 0.1);
color: var(--primary);
}
.admin-panel {
display: none;
position: relative;
}
.admin-header {
display: flex;
justify-content: space-between;
align-items: center;
margin-bottom: 30px;
padding-bottom: 15px;
border-bottom: 1px solid var(--gray-light);
}
.admin-title {
font-size: 1.8rem;
font-weight: 600;
color: var(--primary);
}
.admin-header-buttons {
display: flex;
gap: 10px;
}
.lessons-container {
margin-bottom: 30px;
}
.lessons-header {
display: flex;
justify-content: space-between;
align-items: center;
margin-bottom: 20px;
flex-wrap: wrap;
gap: 10px;
}
.lessons-title {
font-size: 1.5rem;
font-weight: 600;
color: var(--dark);
}
.lesson-card {
background-color: white;
border-radius: 12px;
padding: 20px;
margin-bottom: 15px;
box-shadow: 0 4px 6px rgba(0, 0, 0, 0.05);
border-left: 5px solid var(--primary);
transition: var(--transition);
cursor: move;
position: relative;
}
.lesson-card:hover {
transform: translateY(-3px);
box-shadow: 0 8px 15px rgba(0, 0, 0, 0.1);
}
.lesson-card.dragging {
opacity: 0.5;
cursor: move;
}
.lesson-card.drag-over {
border-top: 3px dashed var(--primary);
background-color: rgba(79, 70, 229, 0.05);
}
.lesson-card-header {
display: flex;
justify-content: space-between;
align-items: center;
margin-bottom: 10px;
}
.lesson-card-title {
font-size: 1.2rem;
font-weight: 600;
color: var(--primary);
}
.lesson-level {
display: flex;
align-items: center;
gap: 5px;
color: var(--gray);
}
.stars {
color: #fbbf24;
}
.lesson-content {
margin-bottom: 15px;
color: var(--gray);
line-height: 1.6;
max-height: 100px;
overflow-y: auto;
}
.lesson-actions {
display: flex;
gap: 10px;
}
.lesson-actions button {
padding: 8px 15px;
font-size: 0.9rem;
}
.lesson-form {
background-color: var(--light);
border-radius: 12px;
padding: 25px;
margin-bottom: 30px;
display: none;
}
.lesson-form.active {
display: block;
}
.form-actions {
display: flex;
gap: 15px;
margin-top: 20px;
}
.student-panel {
display: none;
}
.lesson-info {
display: flex;
justify-content: space-between;
align-items: center;
margin-bottom: 15px;
padding: 15px 20px;
background-color: var(--light);
border-radius: 12px;
border-left: 5px solid var(--primary);
}
.lesson-selector {
display: flex;
align-items: center;
gap: 15px;
}
.lesson-selector select {
padding: 8px 15px;
border: 1px solid var(--gray-light);
border-radius: 8px;
font-size: 1rem;
background-color: white;
cursor: pointer;
}
.lesson-title {
font-size: 1.5rem;
font-weight: 600;
color: var(--primary);
}
.lesson-level {
display: flex;
align-items: center;
gap: 8px;
color: var(--gray);
}
.progress-bar {
height: 8px;
background-color: var(--gray-light);
border-radius: 4px;
margin-bottom: 20px;
overflow: hidden;
}
.progress {
height: 100%;
background: linear-gradient(90deg, var(--primary) 0%, var(--primary-light) 100%);
border-radius: 4px;
width: 0%;
transition: width 0.5s ease;
}
.typing-area {
background-color: var(--light);
border-radius: 12px;
padding: 20px;
margin-bottom: 20px;
box-shadow: 0 4px 6px rgba(0, 0, 0, 0.05);
overflow: hidden; /* Prevenir scroll */
}
.text-display {
font-size: 1.8rem;
line-height: 1.8;
margin-bottom: 15px;
padding: 20px;
border-radius: 10px;
background-color: white;
box-shadow: inset 0 2px 4px rgba(0, 0, 0, 0.06);
border: 1px solid var(--gray-light);
min-height: 200px;
max-height: 400px;
letter-spacing: 0.5px;
overflow-y: auto; /* Permitir desplazamiento vertical */
white-space: pre-wrap; /* Respetar saltos de línea */
word-wrap: break-word; /* Romper palabras largas */
position: relative; /* Para posicionamiento del cursor */
}
.char {
position: relative;
transition: var(--transition);
padding: 2px 0;
display: inline-block; /* Asegurar que se comporte como bloque en línea */
}
.char.current {
background-color: var(--primary);
color: white;
border-radius: 4px;
animation: pulse 1s infinite;
}
.char.correct {
background-color: var(--secondary);
color: white;
border-radius: 4px;
}
.char.incorrect {
background-color: var(--danger);
color: white;
border-radius: 4px;
position: relative;
}
.char.incorrect::after {
content: '✗';
position: absolute;
top: -8px;
right: -8px;
background-color: var(--danger);
color: white;
border-radius: 50%;
width: 18px;
height: 18px;
display: flex;
align-items: center;
justify-content: center;
font-size: 12px;
font-weight: bold;
z-index: 10; /* Asegurar que esté por encima */
transform: translate(0, 0); /* Evitar que afecte el flujo del documento */
}
@keyframes pulse {
0% { opacity: 1; }
50% { opacity: 0.7; }
100% { opacity: 1; }
}
.keyboard-container {
background-color: var(--dark);
border-radius: 12px;
padding: 12px;
box-shadow: 0 10px 25px rgba(0, 0, 0, 0.2);
margin-bottom: 20px;
position: relative;
}
.keyboard-row {
display: flex;
justify-content: center;
margin-bottom: 6px;
}
.key {
background-color: #334155;
color: white;
border: none;
border-radius: 6px;
padding: 10px;
margin: 0 2px;
font-size: 0.85rem;
font-weight: 500;
min-width: 35px;
cursor: pointer;
transition: var(--transition);
box-shadow: 0 3px 0 #1e293b;
display: flex;
flex-direction: column;
align-items: center;
justify-content: center;
position: relative;
}
.key:hover {
filter: brightness(1.1);
}
.key.space {
min-width: 200px;
}
.key.active {
transform: translateY(3px);
box-shadow: 0 0 0 #1e293b;
filter: brightness(1.3);
}
.key.correct {
transform: translateY(3px);
box-shadow: 0 0 0 #1e293b;
filter: brightness(1.3);
}
.key.incorrect {
transform: translateY(3px);
box-shadow: 0 0 0 #1e293b;
filter: brightness(0.7);
}

/* Colores para teclas según dedo */
.key.left-pinky {
background-color: var(--left-pinky-color);
}
.key.left-ring {
background-color: var(--left-ring-color);
}
.key.left-middle {
background-color: var(--left-middle-color);
}
.key.left-index {
background-color: var(--left-index-color);
}
.key.right-index {
background-color: var(--right-index-color);
}
.key.right-middle {
background-color: var(--right-middle-color);
}
.key.right-ring {
background-color: var(--right-ring-color);
}
.key.right-pinky {
background-color: var(--right-pinky-color);
}
.key.thumb {
background-color: var(--thumb-color);
}

/* Estilos para caracteres secundarios en teclas */
.key-char-main {
font-size: 0.9rem;
font-weight: 600;
color: white;
}
.key-char-top {
position: absolute;
top: 2px;
left: 4px;
font-size: 0.7rem;
opacity: 0.8;
color: white;
}
.key-char-top-right {
position: absolute;
top: 2px;
right: 4px;
font-size: 0.7rem;
opacity: 0.8;
color: white;
}
.key-char-bottom {
position: absolute;
bottom: 2px;
left: 4px;
font-size: 0.6rem;
opacity: 0.8;
color: white;
}
.key-char-bottom-right {
position: absolute;
bottom: 2px;
right: 4px;
font-size: 0.6rem;
opacity: 0.8;
color: white;
}

/* Símbolos más grandes para la fila numérica y acentos */
.key-large-symbols .key-char-top {
font-size: 0.8rem;
font-weight: 600;
}
.key-large-symbols .key-char-top-right {
font-size: 0.8rem;
font-weight: 600;
}

/* Teclas especiales */
.key-wide {
min-width: 60px;
}
.key-xwide {
min-width: 90px;
}
.key-xxwide {
min-width: 120px;
}
.key-enter {
min-width: 80px;
height: 84px;
}
.key-shift {
min-width: 100px;
}
.key-space {
min-width: 250px;
}

/* Estilo para la tecla esperada */
.key.expected {
box-shadow: 0 0 15px rgba(255, 255, 255, 0.8);
transform: scale(1.1);
z-index: 10;
border: 2px solid white;
animation: glow 1.5s infinite alternate;
}

@keyframes glow {
from {
box-shadow: 0 0 15px rgba(255, 255, 255, 0.8);
}
to {
box-shadow: 0 0 20px rgba(255, 255, 255, 1), 0 0 30px rgba(255, 255, 255, 0.8);
}
}

.stats-container {
display: grid;
grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
gap: 20px;
margin-bottom: 20px;
}
.stat-card {
background-color: white;
border-radius: 12px;
padding: 20px;
box-shadow: 0 4px 6px rgba(0, 0, 0, 0.05);
text-align: center;
transition: var(--transition);
border-top: 4px solid var(--primary);
}
.stat-card:hover {
transform: translateY(-5px);
box-shadow: 0 10px 15px rgba(0, 0, 0, 0.1);
}
.stat-card.accuracy {
border-top-color: var(--secondary);
}
.stat-card.time {
border-top-color: #f59e0b;
}
.stat-card.errors {
border-top-color: var(--danger);
}
.stat-icon {
font-size: 2rem;
margin-bottom: 10px;
color: var(--primary);
}
.stat-card.accuracy .stat-icon {
color: var(--secondary);
}
.stat-card.time .stat-icon {
color: #f59e0b;
}
.stat-card.errors .stat-icon {
color: var(--danger);
}
.stat-value {
font-size: 2.5rem;
font-weight: 700;
margin-bottom: 5px;
color: var(--dark);
}
.stat-label {
font-size: 1rem;
color: var(--gray);
font-weight: 500;
}
.controls {
display: flex;
justify-content: center;
gap: 20px;
margin-top: 20px;
}
.result-modal {
position: fixed;
top: 0;
left: 0;
width: 100%;
height: 100%;
background-color: rgba(0, 0, 0, 0.7);
display: flex;
justify-content: center;
align-items: center;
z-index: 1000;
opacity: 0;
visibility: hidden;
transition: var(--transition);
}
.result-modal.show {
opacity: 1;
visibility: visible;
}
.modal-content {
background-color: white;
border-radius: 16px;
padding: 40px;
max-width: 500px;
width: 90%;
text-align: center;
transform: scale(0.8);
transition: var(--transition);
}
.result-modal.show .modal-content {
transform: scale(1);
}
.result-title {
font-size: 2rem;
font-weight: 700;
margin-bottom: 20px;
color: var(--primary);
}
.result-stats {
display: grid;
grid-template-columns: repeat(2, 1fr);
gap: 20px;
margin: 30px 0;
}
.result-stat {
padding: 15px;
background-color: var(--light);
border-radius: 10px;
}
.result-stat-value {
font-size: 1.8rem;
font-weight: 700;
color: var(--primary);
}
.result-stat-label {
color: var(--gray);
margin-top: 5px;
}
.close-modal {
background-color: var(--primary);
color: white;
border: none;
border-radius: 8px;
padding: 12px 25px;
font-size: 1rem;
font-weight: 600;
cursor: pointer;
transition: var(--transition);
}
.close-modal:hover {
background-color: #4338ca;
}
.finger-guide {
display: flex;
justify-content: center;
gap: 15px;
margin-bottom: 15px;
flex-wrap: wrap;
}
.finger-item {
display: flex;
align-items: center;
gap: 5px;
font-size: 0.85rem;
color: var(--gray);
}
.finger-color {
width: 12px;
height: 12px;
border-radius: 50%;
}
.notification {
position: fixed;
top: 20px;
right: 20px;
padding: 15px 20px;
border-radius: 8px;
color: white;
font-weight: 500;
box-shadow: var(--shadow);
z-index: 2000;
transform: translateX(150%);
transition: transform 0.3s ease;
}
.notification.show {
transform: translateX(0);
}
.notification.success {
background-color: var(--secondary);
}
.notification.error {
background-color: var(--danger);
}
.notification.info {
background-color: var(--primary);
}
/* Estilos para el panel de estadísticas */
.stats-panel {
display: none;
}
.stats-header {
display: flex;
justify-content: space-between;
align-items: center;
margin-bottom: 30px;
padding-bottom: 15px;
border-bottom: 1px solid var(--gray-light);
}
.stats-title {
font-size: 1.8rem;
font-weight: 600;
color: var(--primary);
}
.stats-content {
background-color: white;
border-radius: 12px;
padding: 25px;
box-shadow: 0 4px 6px rgba(0, 0, 0, 0.05);
}
.stats-summary {
display: grid;
grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
gap: 20px;
margin-bottom: 30px;
}
.stats-history {
margin-top: 30px;
}
.history-table {
width: 100%;
border-collapse: collapse;
}
.history-table th, .history-table td {
padding: 12px 15px;
text-align: left;
border-bottom: 1px solid var(--gray-light);
}
.history-table th {
background-color: var(--light);
font-weight: 600;
color: var(--dark);
}
.history-table tr:hover {
background-color: rgba(79, 70, 229, 0.05);
}
.print-btn {
background-color: var(--secondary);
}
.print-btn:hover {
background-color: #0d9488;
}
/* Estilos para la impresión */
@media print {
body * {
visibility: hidden;
}
.print-area, .print-area * {
visibility: visible;
}
.print-area {
position: absolute;
left: 0;
top: 0;
width: 100%;
}
}
/* Formulario de registro */
.register-form {
display: none;
}
.register-title {
font-size: 2rem;
font-weight: 700;
margin-bottom: 30px;
text-align: center;
color: var(--primary);
}
.login-register-toggle {
text-align: center;
margin-top: 20px;
}
.login-register-toggle a {
color: var(--primary);
text-decoration: none;
font-weight: 500;
}
.login-register-toggle a:hover {
text-decoration: underline;
}

/* Estilos para el sistema de gestión de alumnos */
.admin-section {
background: white;
border-radius: 12px;
padding: 20px;
margin-bottom: 30px;
box-shadow: 0 4px 6px rgba(0, 0, 0, 0.05);
}

.section-actions {
display: flex;
gap: 10px;
margin-bottom: 20px;
flex-wrap: wrap;
}

.student-item {
background: var(--light);
border-radius: 8px;
padding: 15px;
margin-bottom: 10px;
display: flex;
justify-content: space-between;
align-items: center;
border-left: 4px solid var(--primary);
}

.student-info {
flex: 1;
}

.student-name {
font-size: 1.1rem;
font-weight: 600;
color: var(--primary);
}

.student-code {
font-family: monospace;
font-size: 1rem;
color: var(--gray);
margin-top: 5px;
}

.student-actions {
display: flex;
gap: 5px;
}

.btn-sm {
padding: 6px 10px;
font-size: 0.8rem;
}

.student-form {
background-color: var(--light);
border-radius: 12px;
padding: 25px;
margin-bottom: 30px;
display: none;
}

.student-form.active {
display: block;
}

.student-stats {
display: flex;
gap: 20px;
margin-top: 20px;
padding: 15px;
background: var(--light);
border-radius: 8px;
}

.student-stats p {
margin: 0;
}

.student-stats span {
font-weight: 600;
color: var(--primary);
}

/* Estilos para el botón inferior de nueva lección en el panel de administrador */
#admin-lesson-btn-bottom {
position: fixed;
bottom: 30px;
right: 30px;
width: auto;
padding: 15px 25px;
border-radius: 50px;
box-shadow: 0 6px 20px rgba(79, 70, 229, 0.4);
z-index: 100;
display: none;
}

/* Estilos para el indicador de arrastre */
.drag-handle {
position: absolute;
top: 15px;
right: 15px;
color: var(--gray);
cursor: move;
font-size: 1.2rem;
opacity: 0.7;
}

.drag-handle:hover {
color: var(--primary);
opacity: 1;
}

.lesson-number {
position: absolute;
top: 15px;
left: 15px;
background-color: var(--primary);
color: white;
width: 30px;
height: 30px;
border-radius: 50%;
display: flex;
align-items: center;
justify-content: center;
font-weight: bold;
font-size: 0.9rem;
}

/* Contenedor de botones de lecciones */
.lessons-buttons {
display: flex;
gap: 10px;
flex-wrap: wrap;
}

/* Modal para cambiar contraseña */
.password-modal {
position: fixed;
top: 0;
left: 0;
width: 100%;
height: 100%;
background-color: rgba(0, 0, 0, 0.7);
display: flex;
justify-content: center;
align-items: center;
z-index: 1000;
opacity: 0;
visibility: hidden;
transition: var(--transition);
}

.password-modal.show {
opacity: 1;
visibility: visible;
}

.password-modal .modal-content {
background-color: white;
border-radius: 16px;
padding: 30px;
max-width: 400px;
width: 90%;
text-align: center;
transform: scale(0.8);
transition: var(--transition);
}

.password-modal.show .modal-content {
transform: scale(1);
}

.password-modal .result-title {
font-size: 1.5rem;
margin-bottom: 20px;
}

.password-modal .form-group {
margin-bottom: 15px;
text-align: left;
}

.password-modal .form-actions {
margin-top: 20px;
}

@media (max-width: 768px) {
.app-header h1 {
font-size: 2rem;
}

.text-display {
font-size: 1.4rem;
padding: 15px;
}

.key {
min-width: 28px;
padding: 8px;
font-size: 0.75rem;
margin: 0 1px;
}

.key.space {
min-width: 120px;
}

.keyboard-row {
margin-bottom: 4px;
}

.typing-area {
padding: 15px;
}

.main-content {
padding: 20px;
}

.lesson-card-header {
flex-direction: column;
align-items: flex-start;
gap: 10px;
}

.lesson-actions {
width: 100%;
}

.form-actions {
flex-direction: column;
}

.lesson-selector {
flex-direction: column;
align-items: flex-start;
gap: 10px;
}

.stats-summary {
grid-template-columns: 1fr;
}

.history-table {
font-size: 0.9rem;
}

.history-table th, .history-table td {
padding: 8px 10px;
}

#admin-lesson-btn-bottom {
bottom: 20px;
right: 20px;
padding: 12px 20px;
}

.lessons-buttons {
flex-direction: column;
}

.admin-header-buttons {
flex-direction: column;
gap: 5px;
}
}
</style>
</head>
<body>
<div class="app-container">
<div class="app-header">
<h1>Thames Centre Typing Master</h1>
<p>Mejora tu velocidad y precisión al escribir</p>
</div>

<!-- Pantalla de Login -->
<div id="login-screen" class="main-content">
<div class="login-container">
<!-- Formulario de Login -->
<div id="login-form" class="login-form">
<h2 class="login-title">Acceso al Sistema</h2>
<p class="login-subtitle" id="login-subtitle">Si eres alumno de Thames Centre, introduce tu nombre y código</p>

<div class="user-type">
<button id="student-btn" class="active">Alumno</button>
<button id="admin-btn">Administrador</button>
</div>

<div id="admin-password" class="form-group" style="display: none;">
<label for="password">Contraseña</label>
<input type="password" id="password" placeholder="Introduce la contraseña">
</div>

<div id="student-login" class="form-group">
<label for="student-name">Nombre</label>
<input type="text" id="student-name" placeholder="Introduce tu nombre">
</div>

<div id="student-code" class="form-group">
<label for="student-code-input">Código</label>
<input type="text" id="student-code-input" class="access-code-input" placeholder="Introduce tu código">
</div>

<div class="login-options">
<button id="access-btn" class="btn">
<i class="fas fa-sign-in-alt"></i> Acceder
</button>
<button id="exit-btn" class="btn btn-secondary">
<i class="fas fa-times"></i> Salir
</button>
</div>
</div>
</div>
</div>

<!-- Panel de Administrador -->
<div id="admin-panel" class="main-content admin-panel">
<div class="admin-header">
<h2 class="admin-title">Panel de Administración</h2>
<div class="admin-header-buttons">
<button id="change-password-btn-header" class="btn btn-secondary">
<i class="fas fa-key"></i> Cambiar Contraseña
</button>
<button id="logout-admin" class="btn btn-secondary">
<i class="fas fa-sign-out-alt"></i> Cerrar Sesión
</button>
</div>
</div>

<!-- Gestión de Lecciones -->
<div class="lessons-container">
<div class="lessons-header">
<h3 class="lessons-title">Gestión de Lecciones</h3>
<div class="lessons-buttons">
<button id="export-lessons-btn" class="btn">
<i class="fas fa-download"></i> Exportar
</button>
<button id="import-lessons-btn" class="btn btn-secondary">
<i class="fas fa-upload"></i> Importar
</button>
<button id="new-lesson-btn" class="btn">
<i class="fas fa-plus"></i> Nueva Lección
</button>
</div>
</div>

<div id="lessons-list">
<!-- Las lecciones se cargarán dinámicamente -->
</div>

<div id="lesson-form" class="lesson-form">
<h3 id="form-title">Nueva Lección</h3>

<div class="form-group">
<label for="lesson-title-input">Título</label>
<input type="text" id="lesson-title-input" placeholder="Título de la lección">
</div>

<div class="form-group">
<label for="lesson-level-input">Nivel</label>
<select id="lesson-level-input">
<option value="1">1 estrella</option>
<option value="2">2 estrellas</option>
<option value="3">3 estrellas</option>
</select>
</div>

<div class="form-group">
<label for="lesson-content-input">Contenido</label>
<textarea id="lesson-content-input" placeholder="Texto de la lección"></textarea>
</div>

<div class="form-actions">
<button id="save-lesson-btn" class="btn">
<i class="fas fa-save"></i> Guardar
</button>
<button id="cancel-lesson-btn" class="btn btn-secondary">
<i class="fas fa-times"></i> Cancelar
</button>
</div>
</div>
</div>

<!-- Gestión de Alumnos -->
<div class="admin-section">
<h3 class="lessons-title">Gestión de Alumnos</h3>
<div class="section-actions">
<button id="add-student-btn" class="btn">
<i class="fas fa-user-plus"></i> Añadir Alumno
</button>
<button id="view-students-btn" class="btn btn-secondary">
<i class="fas fa-list"></i> Ver Alumnos
</button>
<button id="export-students-btn" class="btn">
<i class="fas fa-download"></i> Exportar Alumnos
</button>
<button id="import-students-btn" class="btn btn-secondary">
<i class="fas fa-upload"></i> Importar Alumnos
</button>
</div>

<div id="students-management" style="display: none;">
<div class="students-list"></div>
<div class="student-stats">
<p>Total de alumnos: <span id="total-students">0</span></p>
</div>
</div>

<div id="student-form" class="student-form">
<h3 id="student-form-title">Añadir Alumno</h3>

<div class="form-group">
<label for="student-username-input">Nombre de usuario</label>
<input type="text" id="student-username-input" placeholder="Nombre de usuario para el alumno">
</div>

<div class="form-group">
<label for="student-code-input-admin">Código de acceso</label>
<input type="text" id="student-code-input-admin" class="access-code-input" placeholder="Código de acceso para el alumno">
</div>

<div class="form-actions">
<button id="save-student-btn" class="btn">
<i class="fas fa-save"></i> Guardar
</button>
<button id="cancel-student-btn" class="btn btn-secondary">
<i class="fas fa-times"></i> Cancelar
</button>
</div>
</div>
</div>

<!-- Botón flotante inferior de nueva lección para el panel de administrador -->
<button id="admin-lesson-btn-bottom" class="btn">
<i class="fas fa-plus"></i> Nueva Lección
</button>
</div>

<!-- Panel de Alumno -->
<div id="student-panel" class="main-content student-panel">
<div class="lesson-info">
<div class="lesson-selector">
<select id="lesson-select">
<!-- Las lecciones se cargarán dinámicamente -->
</select>
<div class="lesson-title" id="current-lesson-title">Lección 1: Fila central (ASDF JKL;)</div>
</div>
<div class="lesson-level">
<span>Nivel:</span>
<div class="stars" id="current-lesson-stars">
<i class="fas fa-star"></i>
<i class="far fa-star"></i>
<i class="far fa-star"></i>
</div>
</div>
</div>

<div class="progress-bar">
<div class="progress" id="progress"></div>
</div>

<div class="typing-area">
<div id="text-display" class="text-display" tabindex="0"></div>

<div class="finger-guide">
<div class="finger-item">
<div class="finger-color" style="background-color: var(--left-pinky-color)"></div>
<span>Meñique izq.</span>
</div>
<div class="finger-item">
<div class="finger-color" style="background-color: var(--left-ring-color)"></div>
<span>Anular izq.</span>
</div>
<div class="finger-item">
<div class="finger-color" style="background-color: var(--left-middle-color)"></div>
<span>Corazón izq.</span>
</div>
<div class="finger-item">
<div class="finger-color" style="background-color: var(--left-index-color)"></div>
<span>Índice izq.</span>
</div>
<div class="finger-item">
<div class="finger-color" style="background-color: var(--right-index-color)"></div>
<span>Índice der.</span>
</div>
<div class="finger-item">
<div class="finger-color" style="background-color: var(--right-middle-color)"></div>
<span>Corazón der.</span>
</div>
<div class="finger-item">
<div class="finger-color" style="background-color: var(--right-ring-color)"></div>
<span>Anular der.</span>
</div>
<div class="finger-item">
<div class="finger-color" style="background-color: var(--right-pinky-color)"></div>
<span>Meñique der.</span>
</div>
<div class="finger-item">
<div class="finger-color" style="background-color: var(--thumb-color)"></div>
<span>Pulgar</span>
</div>
</div>

<div class="keyboard-container">
<!-- Teclado Español - Fila 1 -->
<div class="keyboard-row key-large-symbols">
<button class="key left-pinky" data-key="º">
<span class="key-char-top">ª</span>
<span class="key-char-main">º</span>
<span class="key-char-bottom-right">\</span>
</button>
<button class="key left-pinky" data-key="1">
<span class="key-char-top">!</span>
<span class="key-char-main">1</span>
<span class="key-char-bottom-right">|</span>
</button>
<button class="key left-ring" data-key="2">
<span class="key-char-top">"</span>
<span class="key-char-main">2</span>
<span class="key-char-bottom-right">@</span>
</button>
<button class="key left-middle" data-key="3">
<span class="key-char-top">·</span>
<span class="key-char-main">3</span>
<span class="key-char-bottom-right">#</span>
</button>
<button class="key left-index" data-key="4">
<span class="key-char-top">$</span>
<span class="key-char-main">4</span>
</button>
<button class="key left-index" data-key="5">
<span class="key-char-top">%</span>
<span class="key-char-main">5</span>
</button>
<button class="key right-index" data-key="6">
<span class="key-char-top">&</span>
<span class="key-char-main">6</span>
</button>
<button class="key right-index" data-key="7">
<span class="key-char-top">/</span>
<span class="key-char-main">7</span>
</button>
<button class="key right-middle" data-key="8">
<span class="key-char-top">(</span>
<span class="key-char-main">8</span>
</button>
<button class="key right-ring" data-key="9">
<span class="key-char-top">)</span>
<span class="key-char-main">9</span>
</button>
<button class="key right-pinky" data-key="0">
<span class="key-char-top">=</span>
<span class="key-char-main">0</span>
</button>
<button class="key right-pinky" data-key="'">
<span class="key-char-top">?</span>
<span class="key-char-main">'</span>
</button>
<button class="key right-pinky" data-key="¡">
<span class="key-char-top">¿</span>
<span class="key-char-main">¡</span>
</button>
<button class="key right-pinky key-wide" data-key="Backspace">
<span class="key-char-main"><i class="fas fa-backspace"></i></span>
</button>
</div>

<!-- Teclado Español - Fila 2 -->
<div class="keyboard-row">
<button class="key left-pinky key-wide" data-key="Tab">
<span class="key-char-main">Tab</span>
</button>
<button class="key left-pinky" data-key="q">
<span class="key-char-main">Q</span>
</button>
<button class="key left-ring" data-key="w">
<span class="key-char-main">W</span>
</button>
<button class="key left-middle" data-key="e">
<span class="key-char-main">E</span>
</button>
<button class="key left-index" data-key="r">
<span class="key-char-main">R</span>
</button>
<button class="key left-index" data-key="t">
<span class="key-char-main">T</span>
</button>
<button class="key right-index" data-key="y">
<span class="key-char-main">Y</span>
</button>
<button class="key right-index" data-key="u">
<span class="key-char-main">U</span>
</button>
<button class="key right-middle" data-key="i">
<span class="key-char-main">I</span>
</button>
<button class="key right-ring" data-key="o">
<span class="key-char-main">O</span>
</button>
<button class="key right-pinky" data-key="p">
<span class="key-char-main">P</span>
</button>
<button class="key right-pinky" data-key="`">
<span class="key-char-top">^</span>
<span class="key-char-main">`</span>
<span class="key-char-bottom-right">[</span>
</button>
<!-- TECLA CORREGIDA: Asterisco -->
<button class="key right-pinky" data-key="*">
<span class="key-char-top">*</span>
<span class="key-char-main">+</span>
<span class="key-char-bottom-right">]</span>
</button>
</div>

<!-- Teclado Español - Fila 3 -->
<div class="keyboard-row">
<button class="key left-pinky key-xwide" data-key="CapsLock">
<span class="key-char-main">Bloq<br>Mayús</span>
</button>
<button class="key left-pinky" data-key="a">
<span class="key-char-main">A</span>
</button>
<button class="key left-ring" data-key="s">
<span class="key-char-main">S</span>
</button>
<button class="key left-middle" data-key="d">
<span class="key-char-main">D</span>
</button>
<button class="key left-index" data-key="f">
<span class="key-char-main">F</span>
</button>
<button class="key left-index" data-key="g">
<span class="key-char-main">G</span>
</button>
<button class="key right-index" data-key="h">
<span class="key-char-main">H</span>
</button>
<button class="key right-index" data-key="j">
<span class="key-char-main">J</span>
</button>
<button class="key right-middle" data-key="k">
<span class="key-char-main">K</span>
</button>
<button class="key right-ring" data-key="l">
<span class="key-char-main">L</span>
</button>
<button class="key right-pinky" data-key="ñ">
<span class="key-char-main">Ñ</span>
</button>
<!-- TECLA CORREGIDA: Diéresis -->
<button class="key right-pinky key-large-symbols" data-key="´">
<span class="key-char-top">¨</span>
<span class="key-char-main">´</span>
<span class="key-char-bottom-right">{</span>
</button>
<!-- TECLA CORREGIDA: Ç -->
<button class="key right-pinky" data-key="ç">
<span class="key-char-top">Ç</span>
<span class="key-char-main">ç</span>
<span class="key-char-bottom-right">}</span>
</button>
<button class="key right-pinky key-enter" data-key="Enter">
<span class="key-char-main">Intro</span>
</button>
</div>

<!-- Teclado Español - Fila 4 -->
<div class="keyboard-row">
<button class="key left-pinky key-shift" data-key="Shift">
<span class="key-char-main">Mayús</span>
</button>
<button class="key left-pinky" data-key="<">
<span class="key-char-top">></span>
<span class="key-char-main">&lt;</span>
</button>
<button class="key left-pinky" data-key="z">
<span class="key-char-main">Z</span>
</button>
<button class="key left-ring" data-key="x">
<span class="key-char-main">X</span>
</button>
<button class="key left-middle" data-key="c">
<span class="key-char-main">C</span>
</button>
<button class="key left-index" data-key="v">
<span class="key-char-main">V</span>
</button>
<button class="key left-index" data-key="b">
<span class="key-char-main">B</span>
</button>
<button class="key right-index" data-key="n">
<span class="key-char-main">N</span>
</button>
<button class="key right-index" data-key="m">
<span class="key-char-main">M</span>
</button>
<button class="key right-middle" data-key=",">
<span class="key-char-top">;</span>
<span class="key-char-main">,</span>
</button>
<button class="key right-ring" data-key=".">
<span class="key-char-top">:</span>
<span class="key-char-main">.</span>
</button>
<button class="key right-pinky" data-key="-">
<span class="key-char-top">_</span>
<span class="key-char-main">-</span>
</button>
<button class="key right-pinky key-shift" data-key="Shift">
<span class="key-char-main">Mayús</span>
</button>
</div>

<!-- Teclado Español - Fila 5 -->
<div class="keyboard-row">
<button class="key left-pinky key-wide" data-key="Control">
<span class="key-char-main">Ctrl</span>
</button>
<button class="key thumb key-wide" data-key="Alt">
<span class="key-char-main">Alt</span>
</button>
<button class="key thumb key-space" data-key=" ">
<span class="key-char-main">Espacio</span>
</button>
<button class="key thumb key-wide" data-key="AltGraph">
<span class="key-char-main">Alt Gr</span>
</button>
<button class="key right-pinky key-wide" data-key="Control">
<span class="key-char-main">Ctrl</span>
</button>
</div>
</div>
</div>

<div class="stats-container">
<div class="stat-card">
<div class="stat-icon"><i class="fas fa-tachometer-alt"></i></div>
<div class="stat-value" id="wpm">0</div>
<div class="stat-label">Palabras por minuto</div>
</div>

<div class="stat-card accuracy">
<div class="stat-icon"><i class="fas fa-bullseye"></i></div>
<div class="stat-value" id="accuracy">100%</div>
<div class="stat-label">Precisión</div>
</div>

<div class="stat-card time">
<div class="stat-icon"><i class="fas fa-clock"></i></div>
<div class="stat-value" id="time">0:00</div>
<div class="stat-label">Tiempo</div>
</div>

<div class="stat-card errors">
<div class="stat-icon"><i class="fas fa-times-circle"></i></div>
<div class="stat-value" id="errors">0</div>
<div class="stat-label">Errores</div>
</div>
</div>

<div class="controls">
<button class="btn" id="restart-btn">
<i class="fas fa-redo"></i> Reiniciar
</button>
<button class="btn btn-secondary" id="stats-btn">
<i class="fas fa-chart-bar"></i> Estadísticas
</button>
<button class="btn btn-secondary" id="logout-student">
<i class="fas fa-sign-out-alt"></i> Cerrar Sesión
</button>
</div>
</div>
</div>

<!-- Panel de Estadísticas -->
<div id="stats-panel" class="main-content stats-panel">
<div class="stats-header">
<h2 class="stats-title">Estadísticas de Progreso</h2>
<button id="back-to-typing" class="btn btn-secondary">
<i class="fas fa-arrow-left"></i> Volver
</button>
</div>

<div class="stats-content print-area">
<div class="stats-summary">
<div class="stat-card">
<div class="stat-icon"><i class="fas fa-book"></i></div>
<div class="stat-value" id="total-lessons">0</div>
<div class="stat-label">Lecciones Completadas</div>
</div>

<div class="stat-card">
<div class="stat-icon"><i class="fas fa-tachometer-alt"></i></div>
<div class="stat-value" id="avg-wpm">0</div>
<div class="stat-label">Velocidad Promedio (PPM)</div>
</div>

<div class="stat-card accuracy">
<div class="stat-icon"><i class="fas fa-bullseye"></i></div>
<div class="stat-value" id="avg-accuracy">0%</div>
<div class="stat-label">Precisión Promedio</div>
</div>

<div class="stat-card errors">
<div class="stat-icon"><i class="fas fa-exclamation-triangle"></i></div>
<div class="stat-value" id="total-errors">0</div>
<div class="stat-label">Total de Errores</div>
</div>
</div>

<div class="stats-history">
<h3 class="lessons-title">Historial de Lecciones</h3>
<table class="history-table">
<thead>
<tr>
<th>Lección</th>
<th>Fecha</th>
<th>Velocidad (PPM)</th>
<th>Precisión</th>
<th>Errores</th>
<th>Tiempo</th>
</tr>
</thead>
<tbody id="history-table-body">
<!-- Las estadísticas se cargarán dinámicamente -->
</tbody>
</table>
</div>

<div class="controls">
<button class="btn print-btn" id="print-stats">
<i class="fas fa-print"></i> Imprimir Estadísticas
</button>
</div>
</div>
</div>

<div class="result-modal" id="result-modal">
<div class="modal-content">
<h2 class="result-title">¡Lección Completada!</h2>
<div class="result-stats">
<div class="result-stat">
<div class="result-stat-value" id="final-wpm">0</div>
<div class="result-stat-label">Palabras por minuto</div>
</div>
<div class="result-stat">
<div class="result-stat-value" id="final-accuracy">0%</div>
<div class="result-stat-label">Precisión</div>
</div>
<div class="result-stat">
<div class="result-stat-value" id="final-time">0:00</div>
<div class="result-stat-label">Tiempo</div>
</div>
<div class="result-stat">
<div class="result-stat-value" id="final-errors">0</div>
<div class="result-stat-label">Errores</div>
</div>
</div>
<button class="close-modal" id="close-modal">Continuar</button>
</div>
</div>

<!-- Modal para cambiar contraseña -->
<div id="password-modal" class="password-modal">
<div class="modal-content">
<h2 class="result-title">Cambiar Contraseña</h2>
<div class="form-group">
<label for="modal-current-password">Contraseña Actual</label>
<input type="password" id="modal-current-password" placeholder="Introduce la contraseña actual">
</div>
<div class="form-group">
<label for="modal-new-password">Nueva Contraseña</label>
<input type="password" id="modal-new-password" placeholder="Introduce la nueva contraseña">
</div>
<div class="form-group">
<label for="modal-confirm-password">Confirmar Nueva Contraseña</label>
<input type="password" id="modal-confirm-password" placeholder="Confirma la nueva contraseña">
</div>
<div class="form-actions">
<button id="save-password-btn" class="btn">
<i class="fas fa-save"></i> Guardar
</button>
<button id="cancel-password-btn" class="btn btn-secondary">
<i class="fas fa-times"></i> Cancelar
</button>
</div>
</div>
</div>

<!-- Input de archivo oculto para importar lecciones -->
<input type="file" id="file-input" accept=".json" style="display: none;">

<script>
// Variables globales
let currentUser = null;
let lessons = [];
let currentLesson = null;
let currentIndex = 0;
let startTime = null;
let correctChars = 0;
let incorrectChars = 0;
let timerInterval = null;
let totalErrors = 0;
let exerciseCompleted = false;
let editingLessonId = null;
let users = [];
let userStats = [];
let draggedElement = null; // Elemento arrastrado
let editingStudentId = null;
let adminPassword = "admin123"; // Contraseña por defecto
let userInput = ''; // Almacena el texto que el usuario ha escrito
let typingActive = false; // Indica si estamos en modo escritura

// Elementos del DOM
const loginScreen = document.getElementById('login-screen');
const adminPanel = document.getElementById('admin-panel');
const studentPanel = document.getElementById('student-panel');
const statsPanel = document.getElementById('stats-panel');
const loginForm = document.getElementById('login-form');
const loginSubtitle = document.getElementById('login-subtitle');
const studentBtn = document.getElementById('student-btn');
const adminBtn = document.getElementById('admin-btn');
const adminPasswordDiv = document.getElementById('admin-password');
const passwordInput = document.getElementById('password');
const studentLoginDiv = document.getElementById('student-login');
const studentCodeDiv = document.getElementById('student-code');
const studentNameInput = document.getElementById('student-name');
const studentCodeInput = document.getElementById('student-code-input');
const accessBtn = document.getElementById('access-btn');
const exitBtn = document.getElementById('exit-btn');
const logoutAdminBtn = document.getElementById('logout-admin');
const logoutStudentBtn = document.getElementById('logout-student');
const statsBtn = document.getElementById('stats-btn');
const backToTyping = document.getElementById('back-to-typing');
const printStats = document.getElementById('print-stats');
const newLessonBtn = document.getElementById('new-lesson-btn');
const adminLessonBtnBottom = document.getElementById('admin-lesson-btn-bottom');
const addStudentBtn = document.getElementById('add-student-btn');
const viewStudentsBtn = document.getElementById('view-students-btn');
const studentsManagement = document.getElementById('students-management');
const studentForm = document.getElementById('student-form');
const studentFormTitle = document.getElementById('student-form-title');
const studentUsernameInput = document.getElementById('student-username-input');
const studentCodeInputAdmin = document.getElementById('student-code-input-admin');
const saveStudentBtn = document.getElementById('save-student-btn');
const cancelStudentBtn = document.getElementById('cancel-student-btn');
const lessonForm = document.getElementById('lesson-form');
const formTitle = document.getElementById('form-title');
const lessonTitleInput = document.getElementById('lesson-title-input');
const lessonLevelInput = document.getElementById('lesson-level-input');
const lessonContentInput = document.getElementById('lesson-content-input');
const saveLessonBtn = document.getElementById('save-lesson-btn');
const cancelLessonBtn = document.getElementById('cancel-lesson-btn');
const lessonsList = document.getElementById('lessons-list');
const lessonSelect = document.getElementById('lesson-select');
const currentLessonTitle = document.getElementById('current-lesson-title');
const currentLessonStars = document.getElementById('current-lesson-stars');
const textDisplay = document.getElementById('text-display');
const wpmDisplay = document.getElementById('wpm');
const accuracyDisplay = document.getElementById('accuracy');
const timeDisplay = document.getElementById('time');
const errorsDisplay = document.getElementById('errors');
const progressDisplay = document.getElementById('progress');
const restartBtn = document.getElementById('restart-btn');
const resultModal = document.getElementById('result-modal');
const closeModalBtn = document.getElementById('close-modal');
const finalWpm = document.getElementById('final-wpm');
const finalAccuracy = document.getElementById('final-accuracy');
const finalTime = document.getElementById('final-time');
const finalErrors = document.getElementById('final-errors');
const totalLessons = document.getElementById('total-lessons');
const avgWpm = document.getElementById('avg-wpm');
const avgAccuracy = document.getElementById('avg-accuracy');
const totalErrorsStat = document.getElementById('total-errors');
const historyTableBody = document.getElementById('history-table-body');
const exportLessonsBtn = document.getElementById('export-lessons-btn');
const importLessonsBtn = document.getElementById('import-lessons-btn');
const fileInput = document.getElementById('file-input');
const changePasswordBtnHeader = document.getElementById('change-password-btn-header');
const passwordModal = document.getElementById('password-modal');
const savePasswordBtn = document.getElementById('save-password-btn');
const cancelPasswordBtn = document.getElementById('cancel-password-btn');
const modalCurrentPassword = document.getElementById('modal-current-password');
const modalNewPassword = document.getElementById('modal-new-password');
const modalConfirmPassword = document.getElementById('modal-confirm-password');

// Función para generar texto repetitivo de manera segura
function generateRepetitiveText(baseText, repetitions) {
let result = '';
for (let i = 0; i < repetitions; i++) {
result += baseText + ' ';
}
return result.trim();
}

// Función para exportar lecciones a un archivo JSON
function exportLessons() {
const dataStr = JSON.stringify(lessons, null, 2);
const dataUri = 'data:application/json;charset=utf-8,'+ encodeURIComponent(dataStr);

const exportFileDefaultName = 'lecciones.json';

const linkElement = document.createElement('a');
linkElement.setAttribute('href', dataUri);
linkElement.setAttribute('download', exportFileDefaultName);
linkElement.click();

showNotification('Lecciones exportadas correctamente. Recuerda subir este archivo al servidor para hacer los cambios permanentes.', 'success');
}

// Función para importar lecciones desde un archivo JSON
function importLessons(file) {
const reader = new FileReader();
reader.onload = function(e) {
try {
const importedLessons = JSON.parse(e.target.result);

// Validar que el archivo tiene el formato correcto
if (Array.isArray(importedLessons) && importedLessons.length > 0 &&
importedLessons[0].id && importedLessons[0].title && importedLessons[0].content) {

if (confirm('¿Estás seguro de que quieres reemplazar todas las lecciones actuales?')) {
lessons = importedLessons;
saveLessons();
renderLessons();
showNotification('Lecciones importadas correctamente. Recuerda que los cambios solo son permanentes si subes el archivo al servidor.', 'success');
}
} else {
showNotification('El formato del archivo no es válido', 'error');
}
} catch (error) {
showNotification('Error al procesar el archivo', 'error');
}
};
reader.readAsText(file);
}

// Inicializar lecciones basadas en el manual de mecanografía
function initializeDefaultLessons() {
const defaultLessons = [
{
id: 1,
title: "Lección 1: Fila central (ASDF JKL;)",
level: 1,
content: generateRepetitiveText("asdf jklñ", 50),
order: 1
},
{
id: 2,
title: "Lección 2: Fila central (FG JH;)",
level: 1,
content: generateRepetitiveText("fg jh", 50),
order: 2
},
{
id: 3,
title: "Lección 3: Fila central (GF HJ;)",
level: 1,
content: generateRepetitiveText("gf hj", 50),
order: 3
},
{
id: 4,
title: "Lección 4: Fila central (ASA ÑLÑ)",
level: 1,
content: generateRepetitiveText("asa ñlñ", 30),
order: 4
},
{
id: 5,
title: "Lección 5: Filas central (LA LAS)",
level: 2,
content: generateRepetitiveText("la las", 50),
order: 5
},
{
id: 6,
title: "Lección 6: Fila central (HA HAS)",
level: 1,
content: generateRepetitiveText("ha has", 50),
order: 6
},
{
id: 7,
title: "Lección 7: Fila central (DA DAS)",
level: 1,
content: generateRepetitiveText("da das", 50),
order: 7
},
{
id: 8,
title: "Lección 8: Fila central (SAL LAS)",
level: 1,
content: generateRepetitiveText("sal las", 50),
order: 8
},
{
id: 9,
title: "Lección 9: Fila central (LA SALSA)",
level: 1,
content: generateRepetitiveText("la salsa", 50),
order: 9
},
{
id: 10,
title: "Lección 10: Fila central (FAS KAS)",
level: 1,
content: generateRepetitiveText("fas kas", 50),
order: 10
}
];

return defaultLessons;
}

// Funciones para guardar y cargar datos
function saveLessons(lessonsToSave = lessons) {
try {
// Guardar en localStorage como respaldo
localStorage.setItem('typingLessons', JSON.stringify(lessonsToSave));
console.log('Lecciones guardadas correctamente:', lessonsToSave);
} catch (error) {
console.error('Error al guardar las lecciones:', error);
showNotification('Error al guardar las lecciones', 'error');
}
}

function loadLessons() {
try {
// Intentar cargar desde localStorage primero
const savedLessons = localStorage.getItem('typingLessons');
if (savedLessons) {
console.log('Cargando lecciones desde localStorage');
return JSON.parse(savedLessons);
}

// Si no hay en localStorage, intentar cargar desde archivo
console.log('Intentando cargar lecciones desde archivo');
const xhr = new XMLHttpRequest();
xhr.open('GET', 'lecciones.json', false); // false para síncrono
xhr.send();
        
if (xhr.status === 200) {
const lessons = JSON.parse(xhr.responseText);
// Guardar en localStorage como respaldo
localStorage.setItem('typingLessons', JSON.stringify(lessons));
console.log('Lecciones cargadas desde archivo y guardadas en localStorage');
return lessons;
} else {
throw new Error('No se pudo cargar el archivo de lecciones');
}
} catch (error) {
console.error('Error al cargar las lecciones:', error);
showNotification('Usando lecciones predeterminadas', 'info');

// Si falla la carga del archivo, usar las lecciones predeterminadas
const defaultLessons = initializeDefaultLessons();
saveLessons(defaultLessons);
return defaultLessons;
}
}

// Funciones para la gestión de alumnos
function saveUsers() {
    localStorage.setItem('typingUsers', JSON.stringify(users));
}

function loadUsers() {
    const savedUsers = localStorage.getItem('typingUsers');
    if (savedUsers) {
        users = JSON.parse(savedUsers);
    } else {
        users = [];
    }
}

function renderStudents() {
    const studentsList = document.querySelector('.students-list');
    studentsList.innerHTML = '';

    if (users.length === 0) {
        studentsList.innerHTML = '<p>No hay alumnos registrados.</p>';
        document.getElementById('total-students').textContent = '0';
        return;
    }

    users.forEach(user => {
        const studentItem = document.createElement('div');
        studentItem.className = 'student-item';
        studentItem.innerHTML = `
            <div class="student-info">
                <div class="student-name">${user.username}</div>
                <div class="student-code">${user.code}</div>
            </div>
            <div class="student-actions">
                <button class="btn btn-sm btn-danger delete-student-btn" data-id="${user.id}">
                    <i class="fas fa-trash"></i>
                </button>
            </div>
        `;
        studentsList.appendChild(studentItem);
    });

    document.getElementById('total-students').textContent = users.length;
}

function exportStudents() {
    const dataStr = JSON.stringify(users, null, 2);
    const dataUri = 'data:application/json;charset=utf-8,'+ encodeURIComponent(dataStr);
    const exportFileDefaultName = 'alumnos.json';
    const linkElement = document.createElement('a');
    linkElement.setAttribute('href', dataUri);
    linkElement.setAttribute('download', exportFileDefaultName);
    linkElement.click();
    showNotification('Alumnos exportados correctamente.', 'success');
}

function importStudents(file) {
    const reader = new FileReader();
    reader.onload = function(e) {
        try {
            const importedStudents = JSON.parse(e.target.result);
            if (Array.isArray(importedStudents) && importedStudents.length > 0 &&
                importedStudents[0].id && importedStudents[0].username && importedStudents[0].code) {
                if (confirm('¿Estás seguro de que quieres reemplazar todos los alumnos actuales?')) {
                    users = importedStudents;
                    saveUsers();
                    renderStudents();
                    showNotification('Alumnos importados correctamente.', 'success');
                }
            } else {
                showNotification('El formato del archivo no es válido', 'error');
            }
        } catch (error) {
            showNotification('Error al procesar el archivo', 'error');
        }
    };
    reader.readAsText(file);
}

// Función para renderizar las lecciones en el panel de administrador
function renderLessons() {
lessonsList.innerHTML = '';

// Ordenar lecciones por orden
const sortedLessons = [...lessons].sort((a, b) => a.order - b.order);

sortedLessons.forEach((lesson, index) => {
const lessonCard = document.createElement('div');
lessonCard.className = 'lesson-card';
lessonCard.dataset.id = lesson.id;
lessonCard.draggable = true;

// Número de lección
const lessonNumber = document.createElement('div');
lessonNumber.className = 'lesson-number';
lessonNumber.textContent = index + 1;
lessonCard.appendChild(lessonNumber);

// Contenido de la lección
const lessonCardHeader = document.createElement('div');
lessonCardHeader.className = 'lesson-card-header';

const lessonCardTitle = document.createElement('div');
lessonCardTitle.className = 'lesson-card-title';
lessonCardTitle.textContent = lesson.title;
lessonCardHeader.appendChild(lessonCardTitle);

const lessonLevel = document.createElement('div');
lessonLevel.className = 'lesson-level';
lessonLevel.innerHTML = '<span>Nivel:</span><div class="stars">' + 
Array(lesson.level).fill('<i class="fas fa-star"></i>').join('') + 
Array(3 - lesson.level).fill('<i class="far fa-star"></i>').join('') + 
'</div>';
lessonCardHeader.appendChild(lessonLevel);

lessonCard.appendChild(lessonCardHeader);

const lessonContent = document.createElement('div');
lessonContent.className = 'lesson-content';
lessonContent.textContent = lesson.content.substring(0, 150) + (lesson.content.length > 150 ? '...' : '');
lessonCard.appendChild(lessonContent);

const lessonActions = document.createElement('div');
lessonActions.className = 'lesson-actions';

const editBtn = document.createElement('button');
editBtn.className = 'btn';
editBtn.innerHTML = '<i class="fas fa-edit"></i> Editar';
editBtn.addEventListener('click', () => editLesson(lesson.id));
lessonActions.appendChild(editBtn);

const deleteBtn = document.createElement('button');
deleteBtn.className = 'btn btn-danger';
deleteBtn.innerHTML = '<i class="fas fa-trash"></i> Eliminar';
deleteBtn.addEventListener('click', () => deleteLesson(lesson.id));
lessonActions.appendChild(deleteBtn);

lessonCard.appendChild(lessonActions);

// Indicador de arrastre
const dragHandle = document.createElement('div');
dragHandle.className = 'drag-handle';
dragHandle.innerHTML = '<i class="fas fa-grip-vertical"></i>';
lessonCard.appendChild(dragHandle);

// Eventos de arrastre
lessonCard.addEventListener('dragstart', handleDragStart);
lessonCard.addEventListener('dragend', handleDragEnd);
lessonCard.addEventListener('dragover', handleDragOver);
lessonCard.addEventListener('drop', handleDrop);
lessonCard.addEventListener('dragenter', handleDragEnter);
lessonCard.addEventListener('dragleave', handleDragLeave);

lessonsList.appendChild(lessonCard);
});
}

// Función para renderizar las lecciones en el selector del panel de alumno
function renderLessonSelector() {
lessonSelect.innerHTML = '';

// Ordenar lecciones por orden
const sortedLessons = [...lessons].sort((a, b) => a.order - b.order);

if (sortedLessons.length === 0) {
    // Si no hay lecciones, mostrar un mensaje
    const option = document.createElement('option');
    option.value = '';
    option.textContent = 'No hay lecciones disponibles';
    option.disabled = true;
    option.selected = true;
    lessonSelect.appendChild(option);
    
    // Mostrar mensaje en el área de texto
    textDisplay.innerHTML = '<div style="text-align: center; padding: 50px; color: var(--gray);">No hay lecciones disponibles. Contacta al administrador.</div>';
    return;
}

sortedLessons.forEach((lesson, index) => {
const option = document.createElement('option');
option.value = index;
option.textContent = lesson.title;
lessonSelect.appendChild(option);
});

// Cargar la primera lección por defecto
loadLesson(0);
}

// Función para cargar una lección
function loadLesson(index) {
// Ordenar lecciones por orden
const sortedLessons = [...lessons].sort((a, b) => a.order - b.order);
currentLesson = sortedLessons[index];
currentIndex = index;

if (!currentLesson) return;

// Actualizar selector
lessonSelect.value = index;

// Actualizar título y nivel
currentLessonTitle.textContent = currentLesson.title;
currentLessonStars.innerHTML = Array(currentLesson.level).fill('<i class="fas fa-star"></i>').join('') + 
Array(3 - currentLesson.level).fill('<i class="far fa-star"></i>').join('');

// Mostrar el texto de la lección
textDisplay.innerHTML = '';
currentLesson.content.split('').forEach((char, i) => {
const span = document.createElement('span');
span.className = 'char';
span.textContent = char;
if (i === 0) span.classList.add('current');
textDisplay.appendChild(span);
});

// Reiniciar el ejercicio
resetExercise();
}

// Función para reiniciar el ejercicio
function resetExercise() {
currentIndex = 0;
userInput = '';
correctChars = 0;
incorrectChars = 0;
totalErrors = 0;
startTime = null;
typingActive = false;
exerciseCompleted = false;

// Detener el temporizador
if (timerInterval) {
clearInterval(timerInterval);
timerInterval = null;
}

// Actualizar la visualización del texto
const chars = textDisplay.querySelectorAll('.char');
chars.forEach((char, i) => {
char.classList.remove('current', 'correct', 'incorrect');
if (i === 0) char.classList.add('current');
});

// Actualizar estadísticas
updateStats();
updateProgress();
}

// Función para iniciar el ejercicio
function startTyping() {
if (typingActive) return;
typingActive = true;
startTime = Date.now();

// Iniciar el temporizador
timerInterval = setInterval(updateTimer, 100);
}

// Función para manejar la entrada de caracteres
function handleCharacterInput(char) {
if (!typingActive || exerciseCompleted) return;

// Obtener el carácter esperado
const expectedChar = currentLesson.content[currentIndex];

// Actualizar el estado del carácter actual
const currentCharElement = textDisplay.querySelector('.char.current');
if (currentCharElement) {
if (char === expectedChar) {
currentCharElement.classList.remove('current');
currentCharElement.classList.add('correct');
correctChars++;
} else {
currentCharElement.classList.remove('current');
currentCharElement.classList.add('incorrect');
incorrectChars++;
totalErrors++;
}
}

// Actualizar el índice y el carácter actual
userInput += char;
currentIndex++;

// Si hay más caracteres, marcar el siguiente como actual
if (currentIndex < currentLesson.content.length) {
const nextCharElement = textDisplay.querySelectorAll('.char')[currentIndex];
if (nextCharElement) {
nextCharElement.classList.add('current');
}
} else {
// Si no hay más caracteres, el ejercicio está completo
completeExercise();
}

// Actualizar estadísticas y progreso
updateStats();
updateProgress();
}

// Función para manejar la tecla de retroceso
function handleBackspace() {
if (!typingActive || exerciseCompleted || currentIndex === 0) return;

// Si el carácter actual es incorrecto, simplemente borrarlo
const currentCharElement = textDisplay.querySelector('.char.current');
if (currentCharElement && currentCharElement.classList.contains('incorrect')) {
currentCharElement.classList.remove('current', 'incorrect');
incorrectChars--;
totalErrors--;
} else {
// Si no, retroceder al carácter anterior
currentIndex--;
const prevCharElement = textDisplay.querySelectorAll('.char')[currentIndex];
if (prevCharElement) {
prevCharElement.classList.remove('correct');
prevCharElement.classList.add('current');
correctChars--;
}
}

// Actualizar el texto del usuario
userInput = userInput.slice(0, -1);

// Actualizar estadísticas y progreso
updateStats();
updateProgress();
}

// Función para completar el ejercicio
function completeExercise() {
exerciseCompleted = true;
typingActive = false;

// Detener el temporizador
if (timerInterval) {
clearInterval(timerInterval);
timerInterval = null;
}

// Calcular estadísticas finales
const elapsedTime = (Date.now() - startTime) / 1000; // en segundos
const minutes = elapsedTime / 60;
const words = currentLesson.content.trim().split(/\s+/).length;
const wpm = Math.round(words / minutes);
const accuracy = Math.round((correctChars / (correctChars + incorrectChars)) * 100);

// Guardar estadísticas del usuario
saveUserStats({
lessonId: currentLesson.id,
lessonTitle: currentLesson.title,
wpm: wpm,
accuracy: accuracy,
errors: totalErrors,
time: elapsedTime,
date: new Date().toISOString()
});

// Mostrar el modal de resultados
finalWpm.textContent = wpm;
finalAccuracy.textContent = accuracy + '%';
finalTime.textContent = formatTime(elapsedTime);
finalErrors.textContent = totalErrors;
resultModal.classList.add('show');
}

// Función para guardar las estadísticas del usuario
function saveUserStats(stats) {
// Si no hay estadísticas para este usuario, inicializar el array
if (!userStats[currentUser.id]) {
userStats[currentUser.id] = [];
}

// Añadir las nuevas estadísticas
userStats[currentUser.id].push(stats);

// Guardar en localStorage
localStorage.setItem('typingUserStats', JSON.stringify(userStats));
}

// Función para actualizar las estadísticas en tiempo real
function updateStats() {
if (!startTime) {
wpmDisplay.textContent = '0';
accuracyDisplay.textContent = '100%';
errorsDisplay.textContent = '0';
return;
}

// Calcular tiempo transcurrido
const elapsedTime = (Date.now() - startTime) / 1000; // en segundos

// Calcular palabras por minuto (PPM)
const minutes = elapsedTime / 60;
const words = userInput.trim().split(/\s+/).length;
const wpm = Math.round(words / minutes);
wpmDisplay.textContent = wpm;

// Calcular precisión
const accuracy = correctChars + incorrectChars > 0 
? Math.round((correctChars / (correctChars + incorrectChars)) * 100) 
: 100;
accuracyDisplay.textContent = accuracy + '%';

// Actualizar errores
errorsDisplay.textContent = totalErrors;
}

// Función para actualizar el temporizador
function updateTimer() {
if (!startTime) return;
const elapsedTime = (Date.now() - startTime) / 1000; // en segundos
timeDisplay.textContent = formatTime(elapsedTime);
}

// Función para formatear el tiempo (segundos a MM:SS)
function formatTime(seconds) {
const mins = Math.floor(seconds / 60);
const secs = Math.floor(seconds % 60);
return `${mins}:${secs < 10 ? '0' : ''}${secs}`;
}

// Función para actualizar la barra de progreso
function updateProgress() {
const progress = (currentIndex / currentLesson.content.length) * 100;
progressDisplay.style.width = `${progress}%`;
}

// Función para mostrar notificaciones
function showNotification(message, type = 'info') {
const notification = document.createElement('div');
notification.className = `notification ${type}`;
notification.textContent = message;
document.body.appendChild(notification);

// Mostrar la notificación
setTimeout(() => {
notification.classList.add('show');
}, 10);

// Ocultar la notificación después de 3 segundos
setTimeout(() => {
notification.classList.remove('show');
setTimeout(() => {
document.body.removeChild(notification);
}, 300);
}, 3000);
}

// Función para cargar las estadísticas del usuario
function loadUserStats() {
const savedStats = localStorage.getItem('typingUserStats');
if (savedStats) {
userStats = JSON.parse(savedStats);
} else {
userStats = {};
}
}

// Función para mostrar las estadísticas del usuario
function showUserStats() {
if (!currentUser || !userStats[currentUser.id]) {
totalLessons.textContent = '0';
avgWpm.textContent = '0';
avgAccuracy.textContent = '0%';
totalErrorsStat.textContent = '0';
historyTableBody.innerHTML = '<tr><td colspan="6" style="text-align: center;">No hay estadísticas disponibles</td></tr>';
return;
}

const stats = userStats[currentUser.id];
totalLessons.textContent = stats.length;

// Calcular promedios
const totalWpm = stats.reduce((sum, stat) => sum + stat.wpm, 0);
const totalAccuracy = stats.reduce((sum, stat) => sum + stat.accuracy, 0);
const totalErrors = stats.reduce((sum, stat) => sum + stat.errors, 0);

avgWpm.textContent = Math.round(totalWpm / stats.length);
avgAccuracy.textContent = Math.round(totalAccuracy / stats.length) + '%';
totalErrorsStat.textContent = totalErrors;

// Mostrar historial
historyTableBody.innerHTML = '';
stats.slice().reverse().forEach(stat => {
const row = document.createElement('tr');
row.innerHTML = `
<td>${stat.lessonTitle}</td>
<td>${new Date(stat.date).toLocaleDateString()}</td>
<td>${stat.wpm}</td>
<td>${stat.accuracy}%</td>
<td>${stat.errors}</td>
<td>${formatTime(stat.time)}</td>
`;
historyTableBody.appendChild(row);
});
}

// Función para editar una lección
function editLesson(id) {
const lesson = lessons.find(l => l.id === id);
if (!lesson) return;

editingLessonId = id;
formTitle.textContent = 'Editar Lección';
lessonTitleInput.value = lesson.title;
lessonLevelInput.value = lesson.level;
lessonContentInput.value = lesson.content;
lessonForm.classList.add('active');
}

// Función para eliminar una lección
function deleteLesson(id) {
if (confirm('¿Estás seguro de que quieres eliminar esta lección?')) {
lessons = lessons.filter(l => l.id !== id);
saveLessons();
renderLessons();
renderLessonSelector();
showNotification('Lección eliminada correctamente', 'success');
}
}

// Función para guardar una lección
function saveLesson() {
const title = lessonTitleInput.value.trim();
const level = parseInt(lessonLevelInput.value);
const content = lessonContentInput.value.trim();

if (!title || !content) {
showNotification('Por favor, completa todos los campos', 'error');
return;
}

if (editingLessonId) {
// Editar lección existente
const lessonIndex = lessons.findIndex(l => l.id === editingLessonId);
if (lessonIndex !== -1) {
lessons[lessonIndex] = {
...lessons[lessonIndex],
title,
level,
content
};
showNotification('Lección actualizada correctamente', 'success');
}
} else {
// Crear nueva lección
const newId = lessons.length > 0 ? Math.max(...lessons.map(l => l.id)) + 1 : 1;
const newOrder = lessons.length > 0 ? Math.max(...lessons.map(l => l.order)) + 1 : 1;
lessons.push({
id: newId,
title,
level,
content,
order: newOrder
});
showNotification('Lección creada correctamente', 'success');
}

saveLessons();
renderLessons();
renderLessonSelector();
lessonForm.classList.remove('active');
editingLessonId = null;
}

// Funciones para el arrastre de lecciones
function handleDragStart(e) {
draggedElement = e.target;
e.target.classList.add('dragging');
}

function handleDragEnd(e) {
e.target.classList.remove('dragging');
}

function handleDragOver(e) {
e.preventDefault();
}

function handleDragEnter(e) {
if (e.target.classList.contains('lesson-card') && e.target !== draggedElement) {
e.target.classList.add('drag-over');
}
}

function handleDragLeave(e) {
if (e.target.classList.contains('lesson-card')) {
e.target.classList.remove('drag-over');
}
}

function handleDrop(e) {
e.preventDefault();
if (e.target.classList.contains('lesson-card') && e.target !== draggedElement) {
e.target.classList.remove('drag-over');

// Obtener los IDs de las lecciones
const draggedId = parseInt(draggedElement.dataset.id);
const targetId = parseInt(e.target.dataset.id);

// Obtener las lecciones
const draggedLesson = lessons.find(l => l.id === draggedId);
const targetLesson = lessons.find(l => l.id === targetId);

if (!draggedLesson || !targetLesson) return;

// Intercambiar órdenes
const tempOrder = draggedLesson.order;
draggedLesson.order = targetLesson.order;
targetLesson.order = tempOrder;

// Guardar y volver a renderizar
saveLessons();
renderLessons();
renderLessonSelector();
}
}

// Event Listeners
document.addEventListener('DOMContentLoaded', () => {
// Cargar datos iniciales
loadUsers();
lessons = loadLessons(); // Asignar directamente a la variable global
loadUserStats();

// Renderizar lecciones
renderLessons();
renderLessonSelector();

// Event listeners para el login
studentBtn.addEventListener('click', () => {
studentBtn.classList.add('active');
adminBtn.classList.remove('active');
adminPasswordDiv.style.display = 'none';
studentLoginDiv.style.display = 'block';
studentCodeDiv.style.display = 'block';
loginSubtitle.textContent = 'Si eres alumno de Thames Centre, introduce tu nombre y código';
});

adminBtn.addEventListener('click', () => {
adminBtn.classList.add('active');
studentBtn.classList.remove('active');
adminPasswordDiv.style.display = 'block';
studentLoginDiv.style.display = 'none';
studentCodeDiv.style.display = 'none';
loginSubtitle.textContent = 'Introduce la contraseña de administrador';
});

accessBtn.addEventListener('click', () => {
if (studentBtn.classList.contains('active')) {
// Login de alumno
const name = studentNameInput.value.trim();
const code = studentCodeInput.value.trim();

if (!name || !code) {
showNotification('Por favor, introduce tu nombre y código', 'error');
return;
}

// Verificar si el usuario existe
const user = users.find(u => u.code === code);
if (!user) {
showNotification('Código de acceso incorrecto', 'error');
return;
}

// Iniciar sesión como alumno
currentUser = user;
loginScreen.style.display = 'none';
studentPanel.style.display = 'block';
renderLessonSelector(); // Asegurarse de que las lecciones se muestren
showNotification(`Bienvenido, ${currentUser.username}`, 'success');
} else {
// Login de administrador
const password = passwordInput.value;

if (password !== adminPassword) {
showNotification('Contraseña incorrecta', 'error');
return;
}

// Iniciar sesión como administrador
currentUser = { id: 'admin', username: 'Administrador' };
loginScreen.style.display = 'none';
adminPanel.style.display = 'block';
renderLessons(); // Asegurarse de que las lecciones se muestren
showNotification('Bienvenido al panel de administración', 'success');
}
});

exitBtn.addEventListener('click', () => {
if (confirm('¿Estás seguro de que quieres salir de la aplicación?')) {
window.close();
}
});

logoutAdminBtn.addEventListener('click', () => {
if (confirm('¿Estás seguro de que quieres cerrar sesión?')) {
currentUser = null;
adminPanel.style.display = 'none';
loginScreen.style.display = 'block';
passwordInput.value = '';
}
});

logoutStudentBtn.addEventListener('click', () => {
if (confirm('¿Estás seguro de que quieres cerrar sesión?')) {
currentUser = null;
studentPanel.style.display = 'none';
loginScreen.style.display = 'block';
studentNameInput.value = '';
studentCodeInput.value = '';
}
});

statsBtn.addEventListener('click', () => {
studentPanel.style.display = 'none';
statsPanel.style.display = 'block';
showUserStats();
});

backToTyping.addEventListener('click', () => {
statsPanel.style.display = 'none';
studentPanel.style.display = 'block';
});

printStats.addEventListener('click', () => {
window.print();
});

// Event listeners para la gestión de lecciones
newLessonBtn.addEventListener('click', () => {
editingLessonId = null;
formTitle.textContent = 'Nueva Lección';
lessonTitleInput.value = '';
lessonLevelInput.value = '1';
lessonContentInput.value = '';
lessonForm.classList.add('active');
});

adminLessonBtnBottom.addEventListener('click', () => {
editingLessonId = null;
formTitle.textContent = 'Nueva Lección';
lessonTitleInput.value = '';
lessonLevelInput.value = '1';
lessonContentInput.value = '';
lessonForm.classList.add('active');
});

saveLessonBtn.addEventListener('click', saveLesson);

cancelLessonBtn.addEventListener('click', () => {
lessonForm.classList.remove('active');
editingLessonId = null;
});

exportLessonsBtn.addEventListener('click', exportLessons);

importLessonsBtn.addEventListener('click', () => {
fileInput.click();
});

fileInput.addEventListener('change', (e) => {
if (e.target.files.length > 0) {
importLessons(e.target.files[0]);
}
});

// Event listeners para la gestión de alumnos
document.getElementById('export-students-btn').addEventListener('click', exportStudents);

document.getElementById('import-students-btn').addEventListener('click', () => {
    const input = document.createElement('input');
    input.type = 'file';
    input.accept = '.json';
    input.onchange = e => {
        const file = e.target.files[0];
        if (file) {
            importStudents(file);
        }
    };
    input.click();
});

viewStudentsBtn.addEventListener('click', () => {
    studentsManagement.style.display = studentsManagement.style.display === 'none' ? 'block' : 'none';
    if (studentsManagement.style.display === 'block') {
        renderStudents();
    }
});

// Event listener para guardar alumno
saveStudentBtn.addEventListener('click', () => {
    const username = studentUsernameInput.value.trim();
    const code = studentCodeInputAdmin.value.trim();

    if (!username || !code) {
        showNotification('Por favor, completa todos los campos', 'error');
        return;
    }

    // Verificar si el código ya existe
    if (users.some(user => user.code === code)) {
        showNotification('El código de acceso ya está en uso', 'error');
        return;
    }

    const newStudent = {
        id: Date.now(),
        username,
        code
    };

    users.push(newStudent);
    saveUsers();
    studentForm.classList.remove('active');
    studentUsernameInput.value = '';
    studentCodeInputAdmin.value = '';
    showNotification('Alumno añadido correctamente', 'success');
    renderStudents();
});

// Event listener para cancelar formulario de alumno
cancelStudentBtn.addEventListener('click', () => {
    studentForm.classList.remove('active');
    studentUsernameInput.value = '';
    studentCodeInputAdmin.value = '';
});

// Event listener para mostrar formulario de añadir alumno
addStudentBtn.addEventListener('click', () => {
    studentForm.classList.add('active');
    studentFormTitle.textContent = 'Añadir Alumno';
    studentUsernameInput.value = '';
    studentCodeInputAdmin.value = '';
    editingStudentId = null;
});

// Event listener para cambiar contraseña de administrador
changePasswordBtnHeader.addEventListener('click', () => {
    passwordModal.classList.add('show');
});

savePasswordBtn.addEventListener('click', () => {
    const currentPassword = modalCurrentPassword.value;
    const newPassword = modalNewPassword.value;
    const confirmPassword = modalConfirmPassword.value;

    if (currentPassword !== adminPassword) {
        showNotification('La contraseña actual es incorrecta', 'error');
        return;
    }

    if (newPassword !== confirmPassword) {
        showNotification('Las nuevas contraseñas no coinciden', 'error');
        return;
    }

    if (newPassword.length < 6) {
        showNotification('La nueva contraseña debe tener al menos 6 caracteres', 'error');
        return;
    }

    adminPassword = newPassword;
    showNotification('Contraseña cambiada correctamente', 'success');
    passwordModal.classList.remove('show');
    
    // Limpiar campos
    modalCurrentPassword.value = '';
    modalNewPassword.value = '';
    modalConfirmPassword.value = '';
});

cancelPasswordBtn.addEventListener('click', () => {
    passwordModal.classList.remove('show');
    modalCurrentPassword.value = '';
    modalNewPassword.value = '';
    modalConfirmPassword.value = '';
});

// Event listener para el selector de lecciones
lessonSelect.addEventListener('change', (e) => {
loadLesson(parseInt(e.target.value));
});

// Event listener para el botón de reinicio
restartBtn.addEventListener('click', () => {
resetExercise();
});

// Event listener para el botón de continuar en el modal de resultados
closeModalBtn.addEventListener('click', () => {
    resultModal.classList.remove('show');
    
    // Obtener el índice de la lección actual
    const currentIndex = parseInt(lessonSelect.value);
    const nextIndex = currentIndex + 1;
    
    // Verificar si hay una siguiente lección
    if (nextIndex < lessonSelect.options.length) {
        // Seleccionar la siguiente lección
        lessonSelect.value = nextIndex;
        loadLesson(nextIndex);
    } else {
        // Si no hay más lecciones, recargar la actual
        loadLesson(currentIndex);
    }
    
    resetExercise();
});

// Event listeners para el teclado virtual
document.querySelectorAll('.key').forEach(key => {
key.addEventListener('click', () => {
const keyValue = key.dataset.key;
if (keyValue === 'Backspace') {
handleBackspace();
} else if (keyValue.length === 1) {
handleCharacterInput(keyValue);
}
});
});

// Event listener para el área de texto
textDisplay.addEventListener('keydown', (e) => {
    // Prevenir el scroll con la barra espaciadora
    if (e.key === ' ') {
        e.preventDefault();
    }
    
    if (!typingActive) {
        startTyping();
    }
    
    if (e.key === 'Backspace') {
        handleBackspace();
    } else if (e.key.length === 1) {
        handleCharacterInput(e.key);
    }
});

// Listener global: permite empezar a escribir al pulsar cualquier tecla cuando estemos en el panel de alumno
document.addEventListener('keydown', (e) => {
  try {
    // Solo si el panel de alumno está visible
    if (window.getComputedStyle(studentPanel).display === 'none') return;

    // Ignorar teclas modificadoras y navegación
    const ignoreKeys = ['Shift','Control','Alt','Meta','Tab','Escape'];
    if (ignoreKeys.includes(e.key)) return;

    // Si el foco ya está en un control dentro del panel de alumno, no interferir
    const active = document.activeElement;
    if (active && (active.tagName === 'INPUT' || active.tagName === 'TEXTAREA' || active.tagName === 'SELECT' || active.tagName === 'BUTTON' || active.isContentEditable)) {
      if (studentPanel.contains(active)) return;
    }

    // Evitar que la barra espaciadora haga scroll cuando interceptamos la tecla
    if (e.key === ' ') e.preventDefault();

    // Si textDisplay no tiene foco, enfocarlo y reenviar la tecla como evento sintético
    if (document.activeElement !== textDisplay) {
      textDisplay.focus();

      // Crear evento sintético con propiedades relevantes
      const ev = new KeyboardEvent(e.type, {
        key: e.key,
        code: e.code,
        keyCode: e.keyCode || 0,
        which: e.which || 0,
        altKey: e.altKey,
        ctrlKey: e.ctrlKey,
        shiftKey: e.shiftKey,
        metaKey: e.metaKey,
        bubbles: true,
        cancelable: true
      });

      // Enviar el evento al elemento que maneja la lógica (textDisplay)
      textDisplay.dispatchEvent(ev);

      // Evitar que el evento original siga propagándose (y sea procesado por otros listeners)
      e.stopPropagation();
      e.preventDefault && e.preventDefault();
      return;
    }

    // Si textDisplay ya tiene foco, dejamos que el listener original procese la tecla (no duplicamos)
  } catch (err) {
    console.error('Error en el listener global de teclado:', err);
  }
}, true);



// Event listener para eliminar alumnos - CORREGIDO
document.addEventListener('click', function(e) {
    // Verificar si se hizo clic en un botón de eliminar alumno
    if (e.target.closest('.delete-student-btn')) {
        const deleteButton = e.target.closest('.delete-student-btn');
        const studentId = parseInt(deleteButton.dataset.id);
        
        if (confirm('¿Estás seguro de que quieres eliminar este alumno?')) {
            users = users.filter(user => user.id !== studentId);
            saveUsers();
            renderStudents();
            showNotification('Alumno eliminado correctamente', 'success');
        }
    }
});

// Event listener para resaltar la tecla esperada
function highlightExpectedKey() {
if (!currentLesson || currentIndex >= currentLesson.content.length) return;

const expectedChar = currentLesson.content[currentIndex];
const keyElement = document.querySelector(`.key[data-key="${expectedChar}"]`);

// Eliminar la clase 'expected' de todas las teclas
document.querySelectorAll('.key').forEach(key => {
key.classList.remove('expected');
});

// Añadir la clase 'expected' a la tecla correspondiente
if (keyElement) {
keyElement.classList.add('expected');
}
}

// Actualizar la tecla esperada periódicamente
setInterval(highlightExpectedKey, 100);
});
</script>
<script>
  // Bloquear clic derecho
  document.addEventListener('contextmenu', function(e) {
    e.preventDefault();
    alert('Acción no permitida');
  });

  // Bloquear atajos comunes (F12, Ctrl+Shift+I, Ctrl+U)
  document.addEventListener('keydown', function(e) {
    if (e.key === 'F12') {
      e.preventDefault();
    }
    if (e.ctrlKey && e.shiftKey && e.key.toLowerCase() === 'i') {
      e.preventDefault();
    }
    if (e.ctrlKey && e.key.toLowerCase() === 'u') {
      e.preventDefault();
    }
  });
</script>
</body>
</html>
